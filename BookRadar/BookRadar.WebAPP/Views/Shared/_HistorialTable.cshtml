@model HistorialViewModel
@using System

@{
    var start = Math.Max(1, Model.PageNumber - 2);
    var end = Math.Min(Model.TotalPages, Model.PageNumber + 2);

    if (Model.PageNumber <= 3)
        end = Math.Min(Model.TotalPages, 5);

    if (Model.PageNumber >= Model.TotalPages - 2)
        start = Math.Max(1, Model.TotalPages - 4);

    var pageSizes = new[] { 10, 20, 30, 50 };
}

<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <span class="fw-bold">Historial de Búsquedas</span>

        <form method="get"
              class="d-flex align-items-center gap-2 historial-page-size"
              data-base-url="@Url.Action("IndexHistorialBusqueda", "Search")"
              action="@Url.Action("IndexHistorialBusqueda", "Search")">
            <label for="pageSize" class="form-label mb-0 small white-nowrap">
                Registros por página:
            </label>
            <select id="pageSize" name="pageSize" class="form-select form-select-sm" onchange="this.form.requestSubmit()">
                @foreach (var size in pageSizes)
                {
                    <option value="@size" selected="@(Model.PageSize == size)">@size</option>
                }
            </select>
            <input type="hidden" name="page" value="1" />
        </form>
    </div>

    <div class="card-body p-0">
        @if (Model.Items.Any())
        {
            <div class="table-responsive">
                <table class="table table-hover table-sm align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Autor</th>
                            <th>Título</th>
                            <th style="width:100px;">Año</th>
                            <th>Editorial</th>
                            <th style="width:160px;">Fecha consulta</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model.Items)
                        {
                            <tr>
                                <td>@item.Autor</td>
                                <td>@item.Titulo</td>
                                <td>@(item.AnioPublicacion?.ToString() ?? "—")</td>
                                <td>@(string.IsNullOrWhiteSpace(item.Editorial) ? "—" : item.Editorial)</td>
                                <td>@item.FechaConsultaUtc.ToString("dd/MM/yyyy HH:mm")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="border-top py-2 px-3 d-flex justify-content-between align-items-center flex-wrap">
                <small class="text-muted">
                    Página @Model.PageNumber de @Model.TotalPages · Total: @Model.TotalRows
                </small>

                <nav>
                    <ul class="pagination mb-0 flex-wrap">
                        <li class="page-item @(Model.PageNumber == 1 ? "disabled" : "")">
                            <a class="page-link page-btn" href="@Url.Action("IndexHistorialBusqueda", new { page = 1, pageSize = Model.PageSize })">Primero</a>
                        </li>
                        <li class="page-item @(Model.PageNumber == 1 ? "disabled" : "")">
                            <a class="page-link page-btn" href="@Url.Action("IndexHistorialBusqueda", new { page = Model.PageNumber - 1, pageSize = Model.PageSize })">&laquo;</a>
                        </li>

                        @if (start > 1)
                        {
                            <li class="page-item disabled"><span class="page-link">…</span></li>
                        }

                        @for (int i = start; i <= end; i++)
                        {
                            <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                <a class="page-link page-btn" href="@Url.Action("IndexHistorialBusqueda", new { page = i, pageSize = Model.PageSize })">@i</a>
                            </li>
                        }

                        @if (end < Model.TotalPages)
                        {
                            <li class="page-item disabled"><span class="page-link">…</span></li>
                        }

                        <li class="page-item @(Model.PageNumber == Model.TotalPages ? "disabled" : "")">
                            <a class="page-link page-btn" href="@Url.Action("IndexHistorialBusqueda", new { page = Model.PageNumber + 1, pageSize = Model.PageSize })">&raquo;</a>
                        </li>
                        <li class="page-item @(Model.PageNumber == Model.TotalPages ? "disabled" : "")">
                            <a class="page-link page-btn" href="@Url.Action("IndexHistorialBusqueda", new { page = Model.TotalPages, pageSize = Model.PageSize })">Último</a>
                        </li>
                    </ul>
                </nav>
            </div>
        }
        else
        {
            <div class="text-center text-muted py-4">
                No hay registros en el historial.
            </div>
        }
    </div>
</div>